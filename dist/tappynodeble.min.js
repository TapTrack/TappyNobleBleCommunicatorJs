!function(e){"function"==typeof define&&define.amd?define([],e):module.exports=e()}(function(){return NobleBleCommunicator=function(e){var n=this;if(null==e||"object"!=typeof e.peripheral)throw new Error("Must specify a noble peripheral");this.peripheral=e.peripheral,null!=e&&"number"==typeof e.packetSize?this.packetSize=e.packetSize:this.packetSize=20,this.isConnecting=!1,this.hasConnected=!1,this.isSending=!1,this.rxCharacteristic=null,this.txCharacteristic=null,this.disconnectImmediately=!1,this.disconnectCb=function(){},this.sendBufferArray=new Uint8Array,this.dataReceivedCallback=function(e){},this.errorCallback=function(e){},this.readCallback=function(e){n.dataReceivedCallback(new Uint8Array(e))},this.bleDisconnectCallback=function(){n.errorCallback({error:"Tappy disconnected"}),n.disconnect()}},NobleBleCommunicator.SERIAL_SERVICE_UUID="175f8f23a57049bd9627815a6a27de2a",NobleBleCommunicator.TX_CHAR_UUID="cacc07ffffff4c488faea9ef71b75e26",NobleBleCommunicator.RX_CHAR_UUID="1cce1ea8bd344813a00ac76e028fadcb",NobleBleCommunicator.isAdvertisementForTappy=function(e){return void 0!==e.localName&&null!==e.localName&&-1!==e.localName.indexOf("TAPPY")},NobleBleCommunicator.prototype={connect:function(c){var a,o=this;o.isConnecting||o.isConnected()||(o.isConnecting=!0,a=function(e){o.isConnecting=!1,c(e)},peripheral=o.peripheral,peripheral.connect(function(e){null!=e?a({message:"Failed to connect",error:e}):peripheral.discoverSomeServicesAndCharacteristics([NobleBleCommunicator.SERIAL_SERVICE_UUID],[NobleBleCommunicator.RX_CHAR_UUID,NobleBleCommunicator.TX_CHAR_UUID],function(e,n,i){if(null!==e)peripheral.disconnect(),a({message:"Failed to discover characteristics",error:e});else if(2<=i.length){var r=null,t=null;if(i.forEach(function(e){e.uuid===NobleBleCommunicator.RX_CHAR_UUID?r=e:e.uuid===NobleBleCommunicator.TX_CHAR_UUID&&(t=e)}),null===r||null===t)return void a({message:"Missing required characteristic"});o.rxCharacteristic=r,(o.txCharacteristic=t).on("data",function(e,n){o.readCallback(e)}),t.subscribe(function(e){null!=e?a({message:"Failed to enable notification",error:e}):(o.hasConnected=!0,o.isConnecting=!1,o.peripheral.on("disconnect",o.bleDisconnectCallback),c(),o.disconnectImmediately&&disconnectUnsafe())})}else peripheral.disconnect(),a({message:"Failed to discover characteristics"})})}))},flush:function(e){},isConnected:function(){return this.hasConnected},disconnectUnsafe:function(){var n=this;if(n.isConnecting)throw"Connection still in the process of being established";n.isConnected()&&n.peripheral.disconnect(function(e){"function"==typeof n.disconnectCb&&(null!=e?n.disconnectCb({error:e}):n.disconnectCb()),n.disconnectImmediately=!1,n.isSending=!1,n.hasConnected=!1})},disconnect:function(e){var n=this;n.disconnectImmediately=!0,n.peripheral.removeListener("disconnect",n.bleDisconnectCallback),"function"==typeof e&&(n.disconnectCb=e),!n.isConnecting&&n.isConnected()&&n.disconnectUnsafe()},sendCb:function(e){var n,i=this;null!=e?(i.sendBufferArray=new Uint8Array,i.isSending=!1,i.errorCallback({error:e})):i.isSendBufferEmpty()?i.isSending=!1:(n=i.stripNextChunkFromSendBuffer(),i.rxCharacteristic.write(Buffer.from(n),!1,i.sendCb.bind(i)))},stripNextChunkFromSendBuffer:function(){var e=this;if(e.sendBufferArray.length>e.packetSize){var n=e.sendBufferArray.slice(0,e.packetSize),i=e.sendBufferArray.slice(e.packetSize);return e.sendBufferArray=i,n}var r=e.sendBufferArray;return e.sendBufferArray=new Uint8Array,r},isSendBufferEmpty:function(){return 0===this.sendBufferArray.length},initiateSendIfNecessary:function(){var e,n=this;n.isSending||n.isSendBufferEmpty()||(n.isSending=!0,e=n.stripNextChunkFromSendBuffer(),n.rxCharacteristic.write(Buffer.from(e),!1,n.sendCb.bind(n)))},send:function(e){var n=this,i=new Uint8Array(e),r=new Uint8Array(i.length+n.sendBufferArray.length);r.set(n.sendBufferArray),r.set(i,n.sendBufferArray.length),n.sendBufferArray=r,n.initiateSendIfNecessary()},setDataCallback:function(e){this.dataReceivedCallback=e},setErrorCallback:function(e){this.errorCallback=e}},NobleBleCommunicator});